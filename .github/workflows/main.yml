name: Build & Upload Assets to Supabase

on:
  push:
    # Trigger on any code change
    paths-ignore:
      - ".gitignore"
      - "README.md"

# 1. HARDCODED SLUG NAME
env:
  TOOL_SLUG: "home-value-calculator"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        # Ensure your build script generates a 'dist' folder
        run: npm run build

      - name: Upload Assets to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail

          # Find the files (handling potential Vite hashes in filenames)
          HTML_FILE=$(find dist -name "index.html" | head -n 1)
          JS_FILE=$(find dist -name "*.js" | head -n 1)
          CSS_FILE=$(find dist -name "*.css" | head -n 1)

          echo "ðŸ“¤ Uploading HTML Structure..."
          curl -fSs -X POST "${SUPABASE_URL}/storage/v1/object/apps/${{ env.TOOL_SLUG }}/index.html" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "x-upsert: true" \
            -H "Content-Type: text/html" \
            --data-binary "@$HTML_FILE"

          echo "ðŸ“¤ Uploading CSS Styles..."
          curl -fSs -X POST "${SUPABASE_URL}/storage/v1/object/apps/${{ env.TOOL_SLUG }}/style.css" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "x-upsert: true" \
            -H "Content-Type: text/css" \
            --data-binary "@$CSS_FILE"

          echo "ðŸ“¤ Uploading JS Bundle..."
          curl -fSs -X POST "${SUPABASE_URL}/storage/v1/object/apps/${{ env.TOOL_SLUG }}/bundle.js" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "x-upsert: true" \
            -H "Content-Type: application/javascript" \
            --data-binary "@$JS_FILE"

          echo "âœ… All assets synced for ${{ env.TOOL_SLUG }}"
