name: Build and Sync Tools to Supabase

on:
  push:
    # Trigger on all files/folders
    paths:
      - '**'
    # Specifically ignore changes to .gitignore
    paths-ignore:
      - '.gitignore'
      - 'README.md'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to accurately detect changed folders

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Detect and Process Changed Tools
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # 1. Identify which tool subfolders in /tools/ have changed
          # Comparison is between the current commit and the previous one
          CHANGED_TOOLS=$(git diff --name-only HEAD^ HEAD | grep '^tools/' | cut -d/ -f2 | sort -u)

          if [ -z "$CHANGED_TOOLS" ]; then
            echo "No changes detected in the tools directory. Skipping build."
            exit 0
          fi

          # 2. Loop through each changed tool and process it
          for SLUG in $CHANGED_TOOLS; do
            echo "------------------------------------------"
            echo "Processing Tool: $SLUG"
            echo "------------------------------------------"

            # Build the JS bundle for this specific tool
            # Assuming your vite config handles the entry point dynamically or you have one per tool
            npx vite build --outDir dist/$SLUG

            # Generate the SEO Snapshot (seo.txt)
            node scripts/generate-seo.mjs $SLUG

            echo "Uploading $SLUG to Supabase..."

            # Upload JS Bundle
            curl -X POST "${SUPABASE_URL}/storage/v1/object/apps/$SLUG/bundle.js" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/javascript" \
            -H "x-upsert: true" \
            --data-binary "@dist/$SLUG/index.js"

            # Upload SEO Snapshot
            curl -X POST "${SUPABASE_URL}/storage/v1/object/apps/$SLUG/seo.txt" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: text/plain" \
            -H "x-upsert: true" \
            --data-binary "@dist/$SLUG/seo.txt"

            echo "Done with $SLUG"
          done
