name: Build & Upload Assets to Supabase

on:
  push:
    paths-ignore:
      - ".gitignore"
      - "README.md"

env:
  TOOL_SLUG: "home-value-calculator" # Hardcoded as requested

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build

      - name: Debug Build Folder
        run: |
          echo "Listing dist folder contents:"
          ls -R dist

      - name: Upload Assets to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # 1. Identify files (Vite usually puts them in dist/ or dist/assets/)
          # We search for files specifically to avoid picking up folders
          HTML_FILE=$(find dist -name "tool.html" | head -n 1)
          JS_FILE=$(find dist -name "*.js" | head -n 1)
          CSS_FILE=$(find dist -name "*.css" | head -n 1)

          # Verify files exist before uploading
          if [ -z "$HTML_FILE" ] || [ -z "$JS_FILE" ] || [ -z "$CSS_FILE" ]; then
            echo "‚ùå Error: One or more required files (HTML, JS, CSS) were not found in the build folder."
            exit 1
          fi

          echo "‚úÖ Files found. Starting upload..."

          # Function to upload and print error if it fails
          upload_file() {
            local local_path=$1
            local storage_path=$2
            local content_type=$3

            echo "‚¨ÜÔ∏è Uploading $local_path to $storage_path..."
            
            # Using -w "%{http_code}" to catch the status and -o to see the error message
            RESPONSE=$(curl -s -X POST "${{ secrets.SUPABASE_URL }}/storage/v1/object/BeastTools/${{ env.TOOL_SLUG }}/$storage_path" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              -H "x-upsert: true" \
              -H "Content-Type: $content_type" \
              --data-binary "@$local_path")

            if [[ "$RESPONSE" == *"error"* ]]; then
              echo "‚ùå Supabase Error: $RESPONSE"
              exit 1
            else
              echo "‚úÖ Success"
            fi
          }

          # Execute Uploads
          upload_file "$HTML_FILE" "index.html" "text/html"
          upload_file "$CSS_FILE" "style.css" "text/css"
          upload_file "$JS_FILE" "bundle.js" "application/javascript"

          echo "üéâ All assets synced successfully for ${{ env.TOOL_SLUG }}"
